<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskManager - Inicio de Sesión</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .bg-custom-blue {
        background-color: #0d6efd;
      }

      .auth-container {
        height: 50vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f8f9fa;
      }
      .login-card {
        max-width: 450px;
      }
    </style>
  </head>

  <body>
    <header class="navbar bg-custom-blue py-3 mb-4 justify-content-center">
      <div class="container-fluid justify-content-center">
        <span class="navbar-brand mb-0 h1 fw-bold text-white">TaskManager</span>
      </div>
    </header>

    <div class="auth-container">
      <div class="card shadow login-card w-100">
        <div class="card-header bg-custom-blue text-white text-center">
          <i class="fas fa-lock me-2"></i> Iniciar Sesión
        </div>
        <div class="card-body">
          <!-- Contenedor para mensajes de error o éxito -->
          <div id="message-container" class="mb-3"></div>

          <form id="login-form" onsubmit="manejarLogin(event)">
            <div class="mb-3 text-start">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                name="email"
                required
              />
            </div>

            <div class="mb-3 text-start">
              <label for="password" class="form-label">Contraseña</label>
              <input
                type="password"
                class="form-control"
                id="password"
                name="password"
                required
              />
            </div>

            <!-- REQUERIDO: Elemento para mensajes de error. Su ID es 'error-message'. -->
            <div
              id="error-message"
              class="text-danger mb-3"
              style="display: none"
            ></div>

            <button
              type="submit"
              class="btn btn-dark w-100 mb-3"
              id="login-btn"
            >
              Iniciar Sesión
            </button>
          </form>

          <p class="text-center">
            <a href="usuarios.html" class="text-primary text-decoration-none"
              >¿Nuevo usuario? Regístrate aquí</a
            >
          </p>
          <p class="text-center">
            <a
              href="verification.html"
              class="text-muted text-decoration-none small"
              >¿Olvidaste tu contraseña?</a
            >
          </p>
        </div>
      </div>
    </div>

    <script>
      /**
       * Muestra un mensaje de error o éxito en la interfaz.
       * @param {string} message - El mensaje a mostrar.
       * @param {string} type - El tipo de alerta (danger, success, warning).
       */
      function showMessage(message, type) {
        const container = document.getElementById("message-container");
        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
      }

      function displayError(message) {
        const errorDiv = document.getElementById("error-message"); // AQUI ESTA LA BUSQUEDA DEL ELEMENTO
        // *** ESTE ES EL ELEMENTO CLAVE QUE DEBÍA EXISTIR ***
        if (!errorDiv) {
          // Si errorDiv es null, ejecuta este bloque
          console.error(
            "Error FATAL: No se encontró el div con ID 'error-message'."
          );
          return;
        }

        if (message) {
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
        } else {
          errorDiv.textContent = "";
          errorDiv.style.display = "none"; // Aquí podría estar el error en tu versión
        }
      }

      /**
       * Maneja la sumisión del formulario de login.
       * @param {Event} event - El evento de sumisión.
       */
      async function manejarLogin() {
        event.preventDefault();

        displayError();

        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const errorMessageDiv = document.getElementById("error-message");
        errorMessageDiv.classList.add("d-none");
        errorMessageDiv.textContent = "";

        try {
          // 1. Prepara el cuerpo de la petición API (credenciales)
          const apiBody = JSON.stringify({ email, password });

          // 2. Prepara el payload completo para el Servlet (incluyendo método y endpoint)
          const servletPayload = JSON.stringify({
            metodo: "POST", // Método HTTP para la API de backend
            endpoint: "auth/login", // Endpoint de la API
            body: apiBody, // Cuerpo JSON para la API
          });

          const response = await fetch("Servlet", {
            // Asumo que el Servlet está mapeado en /Servlet
            method: "POST", // Método HTTP para el Servlet (siempre POST)
            headers: { "Content-Type": "application/json" },
            body: servletPayload,
          });

          // El Servlet debería devolver un JSON.
          const responseText = await response.text();
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (e) {
            throw new Error(`Respuesta no JSON del servidor: ${responseText}`);
          }

          if (data && data.token) {
            sessionStorage.setItem("token", data.token); // <-- Guarda el token
            console.log("TOKEN RECIBIDO:", data.token);

            // 2. REDIRECCIÓN EXPLÍCITA SOLO DESPUÉS DE GUARDAR
            window.location.href = "tareas.html";
          } else {
            // Manejar error de credenciales inválidas (la API no devuelve un token)
            const message =
              data.message || "Credenciales inválidas. Inténtalo de nuevo.";
            alertMessage.textContent = message;
            alertMessage.classList.remove("d-none");
          }
        } catch (error) {
          console.error("Error al procesar el login:", error);
          errorMessageDiv.textContent = `Error al procesar el login: ${error.message}`;
          errorMessageDiv.classList.remove("d-none");
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
