<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskManager - Detalle de Tarea</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <style>
    .bg-custom-blue {
      background-color: #0d6efd;
    }

    .detail-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .subtarea-item,
    .comentario-item {
      background: #f8f9fa;
      border-left: 3px solid #0d6efd;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 0.25rem;
    }

    .empleado-badge {
      display: inline-block;
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 15px;
      margin: 5px;
    }

    .estado-badge {
      padding: 5px 15px;
      border-radius: 15px;
      font-weight: bold;
    }

    .estado-Pendiente {
      background: #ffc107;
      color: #000;
    }

    .estado[data-estado="En progreso"] {
      background: #17a2b8;
      color: #fff;
    }

    .estado-Completada {
      background: #28a745;
      color: #fff;
    }
  </style>
</head>

<body class="bg-light">
  <header class="navbar bg-custom-blue py-3 px-3 mb-4 justify-content-between">
    <span class="navbar-brand display-1 h1 fw-bold text-dark">TaskManager - Detalle de Tarea</span>
    <span>
      <a class="navbar-brand display-1 h1 fw-bold text-light" href="/frontend-taskmanager/tareas.html">Gestión de
        tareas</a>
      <a class="navbar-brand display-1 h1 fw-bold text-light" href="/frontend-taskmanager/usuarios.html">Gestión de
        usuarios</a>
    </span>
  </header>

  <div class="container">
    <!-- Botón Volver -->
    <button onclick="window.location.href='/frontend-taskmanager/tareas.html'" class="btn btn-secondary mb-3">
      <i class="fas fa-arrow-left"></i> Volver
    </button>

    <!-- Loading -->
    <div id="loading" class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <!-- Información Principal -->
    <div id="tarea-detail" style="display: none;">
      <div class="detail-card">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h2 id="tarea-nombre"></h2>
            <span id="tarea-estado" class="estado-badge"></span>
          </div>
          <div>
            <button onclick="habilitarEdicion()" class="btn btn-warning me-2">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button onclick="eliminarTarea()" class="btn btn-danger">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <p><strong>Fecha de Creación:</strong> <span id="tarea-fecha"></span></p>
            <p><strong>Gestor Encargado:</strong> <span id="tarea-gestor"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Empleados Asignados:</strong></p>
            <div id="tarea-empleados"></div>
          </div>
        </div>
      </div>

      <!-- Formulario de Edición (oculto por defecto) -->
      <div id="edit-form" class="detail-card" style="display: none;">
        <h4>Editar Tarea</h4>
        <form onsubmit="event.preventDefault(); guardarEdicion();">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="edit-nombre" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select id="edit-estado" class="form-select" required>
              <option value="Pendiente">Pendiente</option>
              <option value="En progreso">En progreso</option>
              <option value="Completada">Completada</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Gestor Encargado</label>
            <select id="edit-gestor" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Empleados Asignados</label>
            <select id="edit-empleados" multiple class="form-select"></select>
            <small>Mantén CTRL para seleccionar varios</small>
          </div>
          <button type="submit" class="btn btn-success me-2">Guardar Cambios</button>
          <button type="button" onclick="cancelarEdicion()" class="btn btn-secondary">Cancelar</button>
        </form>
      </div>

      <!-- Subtareas -->
      <div class="detail-card">
        <h4>Subtareas</h4>
        <div id="subtareas-list"></div>

        <button class="btn btn-sm btn-primary" onclick="toggleSubtareaForm()">
          <i class="fas fa-plus"></i> Añadir Subtarea
        </button>

        <div id="subtarea-form" style="display: none;" class="mt-3">
          <div class="input-group">
            <input type="text" id="nueva-subtarea" class="form-control" placeholder="Nombre de la subtarea" />
            <button class="btn btn-success" onclick="crearSubtarea()">Crear</button>
            <button class="btn btn-secondary" onclick="toggleSubtareaForm()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Comentarios -->
      <div class="detail-card">
        <h4>Comentarios</h4>
        <div id="comentarios-list"></div>

        <div class="mt-3">
          <textarea id="nuevo-comentario" class="form-control mb-2" rows="3"
            placeholder="Escribe un comentario..."></textarea>
          <button class="btn btn-primary" onclick="crearComentario()">
            <i class="fas fa-comment"></i> Añadir Comentario
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = sessionStorage.getItem("token");
    let tareaId = null;
    let tareaActual = null;

    // Obtener ID de la tarea desde URL
    const urlParams = new URLSearchParams(window.location.search);
    tareaId = urlParams.get('id');

    if (!tareaId) {
      alert("No se especificó ID de tarea");
      window.location.href = '/frontend-taskmanager/tareas.html';
    }

    // ------------------ CARGAR DETALLE DE TAREA ------------------
    async function cargarDetalleTarea() {
      const payload = {
        metodo: "GET",
        endpoint: `tarea/${tareaId}`,
        body: null,
        token: token
      };

      try {
        const response = await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error("Error al cargar la tarea");
        }

        tareaActual = await response.json();
        mostrarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al cargar la tarea");
        window.location.href = '/frontend-taskmanager/tareas.html';
      }
    }

    // ------------------ MOSTRAR DETALLE ------------------
    function mostrarDetalleTarea() {
      document.getElementById("loading").style.display = "none";
      document.getElementById("tarea-detail").style.display = "block";

      document.getElementById("tarea-nombre").textContent = tareaActual.nombre;
      document.getElementById("tarea-fecha").textContent = tareaActual.fechaCreacion || "N/A";

      const estadoSpan = document.getElementById("tarea-estado");
      estadoSpan.textContent = tareaActual.estadoTarea || "N/A";
      estadoSpan.className = `estado-badge estado`;
      estadoSpan.dataset.estado = tareaActual.estadoTarea;


      document.getElementById("tarea-gestor").textContent =
        tareaActual.gestorEncargado ?
          `${tareaActual.gestorEncargado.nombre} ${tareaActual.gestorEncargado.apellidos || ''}`.trim() :
          "Sin asignar";

      const empleadosDiv = document.getElementById("tarea-empleados");
      empleadosDiv.innerHTML = "";
      if (tareaActual.empleadosAsignados && tareaActual.empleadosAsignados.length > 0) {
        tareaActual.empleadosAsignados.forEach(emp => {
          const badge = document.createElement("span");
          badge.className = "empleado-badge";
          badge.textContent = `${emp.nombre} ${emp.apellidos || ''}`.trim();
          empleadosDiv.appendChild(badge);
        });
      } else {
        empleadosDiv.innerHTML = "<small>No hay empleados asignados</small>";
      }

      mostrarSubtareas();
      mostrarComentarios();
    }

    // ------------------ SUBTAREAS ------------------
    /*
    function mostrarSubtareas() {
      const list = document.getElementById("subtareas-list");
      list.innerHTML = "";

      if (!tareaActual.subtareas || tareaActual.subtareas.length === 0) {
        list.innerHTML = "<p><small>No hay subtareas</small></p>";
        return;
      }

      tareaActual.subtareas.forEach(sub => {
        const div = document.createElement("div");
        div.className = "subtarea-item";
        div.innerHTML = `
            <strong>${sub.nombre}</strong>
            <button class="btn btn-sm btn-danger float-end" onclick="eliminarSubtarea(${sub.id})">
              <i class="fas fa-trash"></i>
            </button>
          `;
        list.appendChild(div);
      });
    }

    function toggleSubtareaForm() {
      const form = document.getElementById("subtarea-form");
      form.style.display = form.style.display === "none" ? "block" : "none";
      document.getElementById("nueva-subtarea").value = "";
    }

    async function crearSubtarea() {
      const nombre = document.getElementById("nueva-subtarea").value.trim();
      const tareaId = tareaActual.id;
      if (!nombre) return;

      const payload = {
        metodo: "POST",
        endpoint: `subtareas/nueva`,
        body: JSON.stringify({ nombre: nombre, tareaId: tareaId }),
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        toggleSubtareaForm();
        cargarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al crear subtarea");
      }
    }

    async function eliminarSubtarea(subtareaId) {
      if (!confirm("¿Eliminar esta subtarea?")) return;

      const payload = {
        metodo: "DELETE",
        endpoint: `subtarea/${subtareaId}`,
        body: null,
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        cargarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al eliminar subtarea");
      }
    }

    // ------------------ COMENTARIOS ------------------
    function mostrarComentarios() {
      const list = document.getElementById("comentarios-list");
      list.innerHTML = "";

      if (!tareaActual.comentarios || tareaActual.comentarios.length === 0) {
        list.innerHTML = "<p><small>No hay comentarios</small></p>";
        return;
      }

      tareaActual.comentarios.forEach(com => {
        const div = document.createElement("div");
        div.className = "comentario-item";
        div.innerHTML = `
            <p>${com.contenido}</p>
            <small class="text-muted">Por: ${com.autor?.nombre || 'Anónimo'} - ${com.fecha || ''}</small>
            <button class="btn btn-sm btn-danger float-end" onclick="eliminarComentario(${com.id})">
              <i class="fas fa-trash"></i>
            </button>
          `;
        list.appendChild(div);
      });
    }

    async function crearComentario() {
      const contenido = document.getElementById("nuevo-comentario").value.trim();
      if (!contenido) return;

      const payload = {
        metodo: "POST",
        endpoint: `tarea/${tareaId}/comentario`,
        body: JSON.stringify({ contenido: contenido }),
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        document.getElementById("nuevo-comentario").value = "";
        cargarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al crear comentario");
      }
    }

    async function eliminarComentario(comentarioId) {
      if (!confirm("¿Eliminar este comentario?")) return;

      const payload = {
        metodo: "DELETE",
        endpoint: `comentario/${comentarioId}`,
        body: null,
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        cargarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al eliminar comentario");
      }
    }
    */

    // ------------------ EDICIÓN ------------------
    async function habilitarEdicion() {
      document.getElementById("edit-form").style.display = "block";
      document.getElementById("edit-nombre").value = tareaActual.nombre;
      document.getElementById("edit-estado").value = tareaActual.estadoTarea;

      // Cargar usuarios
      await cargarUsuariosParaEdicion();

      // Seleccionar gestor actual
      document.getElementById("edit-gestor").value = tareaActual.gestorEncargado?.id || "";

      // Seleccionar empleados actuales
      const empleadosSelect = document.getElementById("edit-empleados");
      const empleadosIds = tareaActual.empleadosAsignados.map(e => e.id);
      Array.from(empleadosSelect.options).forEach(opt => {
        opt.selected = empleadosIds.includes(parseInt(opt.value));
      });

      window.scrollTo(0, document.getElementById("edit-form").offsetTop);
    }

    async function cargarUsuariosParaEdicion() {
      const payload = {
        metodo: "GET",
        endpoint: "usuarios/listado",
        body: null,
        token: token
      };

      try {
        const response = await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          console.error("Error al cargar usuarios");
          return;
        }

        const result = await response.json();
        console.log("Usuarios cargados:", result);

        const usuarios = Array.isArray(result) ? result : result.data || [];
        const gestores = usuarios.filter(u => u.rol === "Gestor");
        const empleados = usuarios.filter(u => u.rol === "Empleado");

        console.log("Gestores filtrados:", gestores);
        console.log("Empleados filtrados:", empleados);

        const gestorSelect = document.getElementById("edit-gestor");
        gestorSelect.innerHTML = "";

        if (gestores.length === 0) {
          gestorSelect.innerHTML = "<option value=''>No hay gestores disponibles</option>";
        } else {
          gestores.forEach(g => {
            const opt = document.createElement("option");
            opt.value = g.id;
            opt.textContent = `${g.nombre} ${g.apellidos || ''}`.trim();
            gestorSelect.appendChild(opt);
          });
        }

        const empleadosSelect = document.getElementById("edit-empleados");
        empleadosSelect.innerHTML = "";

        if (empleados.length === 0) {
          empleadosSelect.innerHTML = "<option value=''>No hay empleados disponibles</option>";
        } else {
          empleados.forEach(e => {
            const opt = document.createElement("option");
            opt.value = e.id;
            opt.textContent = `${e.nombre} ${e.apellidos || ''}`.trim();
            empleadosSelect.appendChild(opt);
          });
        }

        console.log("Selects poblados correctamente");
      } catch (error) {
        console.error("Error al cargar usuarios:", error);
        alert("Error al cargar los usuarios para edición");
      }
    }

    async function guardarEdicion() {
      const nombre = document.getElementById("edit-nombre").value.trim();
      const estado = document.getElementById("edit-estado").value;
      const gestorId = parseInt(document.getElementById("edit-gestor").value);

      const empleadosSelect = document.getElementById("edit-empleados");
      const empleadosIds = Array.from(empleadosSelect.selectedOptions)
        .map(o => parseInt(o.value));

      const tareaEditada = {
        nombre: nombre,
        estadoTarea: estado,
        gestorEncargado: { id: gestorId },
        empleadosAsignados: empleadosIds.map(id => ({ id: id }))
      };

      const payload = {
        metodo: "PUT",
        endpoint: `tarea/actualizar/${tareaId}`,
        body: JSON.stringify(tareaEditada),
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alert("Tarea actualizada con éxito");
        cancelarEdicion();
        cargarDetalleTarea();
      } catch (error) {
        console.error("Error:", error);
        alert("Error al actualizar la tarea");
      }
    }

    function cancelarEdicion() {
      document.getElementById("edit-form").style.display = "none";
    }

    // ------------------ ELIMINAR TAREA ------------------
    async function eliminarTarea() {
      if (!confirm("¿Estás seguro de eliminar esta tarea? Esta acción no se puede deshacer.")) {
        return;
      }

      const payload = {
        metodo: "DELETE",
        endpoint: `tarea/borrar/${tareaId}`,
        body: null,
        token: token
      };

      try {
        await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alert("Tarea eliminada");
        window.location.href = '/frontend-taskmanager/tareas.html';
      } catch (error) {
        console.error("Error:", error);
        alert("Error al eliminar la tarea");
      }
    }

    // ------------------ INICIALIZACIÓN ------------------
    window.onload = cargarDetalleTarea;
  </script>
</body>

</html>