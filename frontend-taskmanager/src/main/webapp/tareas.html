<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskManager - Gestión de Tareas</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      .bg-custom-blue {
        background-color: #0d6efd;
      }
      .bg-custom-gray {
        background-color: #a2b6d4;
      }
      .main-content {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1200px;
        margin: auto;
      }
      .form-container,
      .list-container {
        padding: 20px;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 50%;
      }
      .task-item {
        margin-bottom: 8px;
        padding: 10px 15px;
        background: white;
        border-radius: 0.5rem;
        cursor: pointer;
      }
    </style>
  </head>

  <body class="bg-light">
    <header class="navbar bg-custom-blue py-3 mb-4 justify-content-center">
      <span class="navbar-brand display-1 h1 fw-bold text-dark"
        >TaskManager - Gestión de Tareas</span
      >
    </header>

    <div class="main-content">
      <!-- FORMULARIO -->
      <div class="form-container bg-white">
        <h3>Crear Nueva Tarea</h3>

        <div id="create-error-message" class="alert alert-danger d-none"></div>

        <form
          id="create-task-form"
          onsubmit="event.preventDefault(); crearTarea();"
        >
          <div class="mb-3">
            <label class="form-label">Nombre de la tarea</label>
            <input
              type="text"
              id="new-task-nombre"
              class="form-control"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select id="new-task-estado" class="form-select" required>
              <option value="PENDIENTE">Pendiente</option>
              <option value="EN_PROGRESO">En progreso</option>
              <option value="COMPLETADA">Completada</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Gestor Encargado</label>
            <select id="new-task-gestor" class="form-select" required>
              <option value="1">Usuario Ejemplo 1</option>
              <option value="2">Usuario Ejemplo 2</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Empleados Asignados</label>
            <select id="new-task-empleados" multiple class="form-select">
              <option value="1">Empleado 1</option>
              <option value="2">Empleado 2</option>
              <option value="3">Empleado 3</option>
            </select>
            <small>Puedes seleccionar varios con CTRL</small>
          </div>

          <button type="submit" class="btn btn-dark w-100 mt-3">
            Crear Tarea
          </button>
        </form>
      </div>

      <!-- LISTADO -->
      <div class="list-container bg-custom-gray">
        <h3>Listado de Tareas</h3>
        <button onclick="listarTareas()" class="btn btn-dark w-100 mb-3">
          Recargar
        </button>
        <div id="listaTareas"></div>
      </div>
    </div>

    <script>
      const token = sessionStorage.getItem("token");

      // ------------------ LISTAR TAREAS ------------------
      async function listarTareas() {
        const lista = document.getElementById("listaTareas");
        lista.innerHTML = "<p>Cargando tareas...</p>";

        const payload = {
          metodo: "GET",
          endpoint: "tarea/listado",
          body: null,
          token: token,
        };

        try {
          const response = await fetch("Servlet", {
            method: "POST", // ✔ SIEMPRE POST AL SERVLET
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload), // ✔ El body ahora es legal
          });

          if (!response.ok) {
            lista.innerHTML =
              "<p class='text-danger'>Error al obtener tareas.</p>";
            return;
          }

          const result = await response.json();

          const tareas = Array.isArray(result)
            ? result
            : result.data && Array.isArray(result.data)
            ? result.data
            : [];

          lista.innerHTML = "";

          if (tareas.length === 0) {
            lista.innerHTML = "<p>No hay tareas registradas.</p>";
            return;
          }

          tareas.forEach((t) => {
            const item = document.createElement("div");
            item.className = "task-item";

            item.innerHTML = `
                <strong>${t.nombre}</strong><br>
                Estado: ${t.estadoTarea || "N/A"}<br>
                Gestor: ${t.gestorEncargado?.nombre || "Sin asignar"}<br>
                Empleados asignados: ${t.empleadosAsignados?.length || 0}
            `;

            lista.appendChild(item);
          });
        } catch (error) {
          console.error("Error:", error);
          lista.innerHTML =
            "<p class='text-danger'>Error al conectar con el servidor.</p>";
        }
      }

      // ------------------ CREAR TAREA ------------------
      async function crearTarea() {
        const nombre = document.getElementById("new-task-nombre").value;
        const estadoTarea = document.getElementById("new-task-estado").value;
        const gestorEncargadoId = parseInt(
          document.getElementById("new-task-gestor").value
        );

        const empleadosSelect = document.getElementById("new-task-empleados");
        const empleadosAsignadosIds = Array.from(
          empleadosSelect.selectedOptions
        ).map((o) => parseInt(o.value));

        const nuevaTarea = {
          nombre,
          fechaCreacion: new Date().toISOString().split("T")[0], // YYYY-MM-DD
          estadoTarea,
          gestorEncargadoId,
          empleadosAsignadosIds,
        };

        const payload = {
          metodo: "POST",
          endpoint: "tarea/nueva",
          body: JSON.stringify(nuevaTarea),
          token: token,
        };

        const response = await fetch("Servlet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (data.id) {
          alert("Tarea creada con éxito");
          document.getElementById("create-task-form").reset();
          listarTareas();
        } else {
          alert("Error al crear la tarea");
        }
      }

      window.onload = listarTareas;
    </script>
  </body>
</html>
