<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TaskManager - Gestión de usuarios</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      /* Estilos reutilizados de la aplicación */
      .bg-custom-blue {
        background-color: #0d6efd;
      }
      .bg-custom-blue-light {
        background-color: #337ff1;
      }
      .bg-custom-gray {
        background-color: #a2b6d4;
      }
      .bg-custom-gray-dark {
        background-color: #6e7a8d;
      }
      .main-content {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        padding: 20px;
        max-width: 1000px;
        margin: 20px auto;
      }
      .form-container,
      .list-container {
        padding: 20px;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 50%;
      }
      .list-item {
        margin-bottom: 8px;
        padding: 10px 15px;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .list-item:hover {
        background-color: #bcc3cd;
      }
      .role-pill {
        padding: 0.25em 0.75em;
        font-size: 0.8em;
        font-weight: 700;
        border-radius: 1rem;
      }
    </style>
  </head>
  <body class="bg-light">
    <header class="navbar bg-custom-blue py-3 mb-4 justify-content-center">
      <div class="container-fluid justify-content-center">
        <span class="navbar-brand mb-0 display-1 h1 fw-bold text-dark"
          >TaskManager - Gestión de Usuarios</span
        >
      </div>
    </header>

    <div class="main-content">
      <!-- Contenedor para el formulario de creación de usuario -->
      <div class="form-container bg-white">
        <h3 class="mb-4">Crear Nuevo Usuario</h3>
        <div
          id="create-error-message"
          class="alert alert-danger d-none"
          role="alert"
        ></div>

        <form
          id="create-user-form"
          onsubmit="event.preventDefault(); crearUsuario();"
        >
          <div class="mb-3">
            <label for="new-user-name" class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              id="new-user-name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="new-user-email" class="form-label"
              >Correo Electrónico</label
            >
            <input
              type="email"
              class="form-control"
              id="new-user-email"
              required
            />
          </div>
          <div class="mb-3">
            <label for="new-user-password" class="form-label">Contraseña</label>
            <input
              type="password"
              class="form-control"
              id="new-user-password"
              required
            />
          </div>

          <!-- Elemento SELECT nativo de HTML, estilizado con Bootstrap 5 -->
          <div class="mb-3">
            <label for="new-user-role" class="form-label">Rol</label>
            <select class="form-select" id="new-user-role" required>
              <option value="Empleado">Empleado</option>
              <option value="Manager">Manager</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-dark w-50">
              Crear Usuario
            </button>
            <button type="reset" class="btn btn-outline-secondary w-50">
              Limpiar campos
            </button>
          </div>
        </form>
      </div>

      <!-- Contenedor para el listado de usuarios -->
      <div class="list-container bg-custom-gray">
        <h3 class="mb-4">Listado de Usuarios</h3>
        <button
          class="btn btn-sm btn-dark mb-3 w-100"
          onclick="listarUsuarios()"
        >
          <i class="fas fa-sync-alt"></i> Recargar Usuarios
        </button>
        <div id="listaUsuarios">
          <!-- El listado dinámico se cargará aquí -->
          <p id="loading-message">Cargando usuarios...</p>
        </div>
      </div>
    </div>

    <footer></footer>

    <script>
      // Verifica el token al inicio. No usa jQuery.
      const token = sessionStorage.getItem("token");

      if (!token) {
        // Redirige si no hay token (usuario no autenticado)
        window.location.href = "login.html";
        throw new Error("No token found. Redirecting to login.");
      }

      function crearElementoUsuario(usuario) {
        const item = document.createElement("div");
        item.className =
          "list-item d-flex justify-content-between align-items-center bg-custom-gray-light shadow-sm";

        // Determinar el color de la pastilla (pill) según el rol
        let roleColorClass = "bg-secondary text-white"; // Default
        if (usuario.rol === "Admin") {
          roleColorClass = "bg-danger text-white";
        } else if (usuario.rol === "Manager") {
          roleColorClass = "bg-primary text-white";
        } else if (usuario.rol === "Empleado") {
          roleColorClass = "bg-success text-white";
        }

        item.innerHTML = `
            <div>
                <h5 class="mb-0">${usuario.nombre}</h5>
                <small class="text-muted">${usuario.email}</small>
            </div>
            <span class="role-pill ${roleColorClass}">
                ${usuario.rol}
            </span>
        `;
        // Listener para posible futura funcionalidad de edición/detalle (Vanilla JS)
        item.addEventListener("click", () => {
          // Ejemplo de uso: console.log(\`Click en usuario: \${usuario.nombre}\`);
        });
        return item;
      }

      // Función de listado (Vanilla JS)
      async function listarUsuarios() {
        const listaUsuariosDiv = document.getElementById("listaUsuarios");
        listaUsuariosDiv.innerHTML =
          "<p id='loading-message'>Cargando usuarios...</p>"; // Mensaje de carga

        if (!token) {
          listaUsuariosDiv.innerHTML =
            "<p class='alert alert-warning'>Error: No hay token de sesión. Redirigiendo...</p>";
          setTimeout(() => (window.location.href = "login.html"), 1000);
          return;
        }

        const payload = {
          metodo: "GET",
          endpoint: "usuario/listado",
          body: null,
          token: token,
        };

        try {
          // Uso de Fetch API (Vanilla JS)
          const response = await fetch("/frontend-taskmanager/Servlet", {
            method: "POST", // El proxy Servlet solo acepta POST
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          // Verificar si la respuesta fue un error HTTP (4xx o 5xx)
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Error HTTP ${response.status}:`, errorText);
            throw new Error(
              `Error HTTP: ${response.status}. Verifique la consola para más detalles.`
            );
          }

          const data = await response.json();
          listaUsuariosDiv.innerHTML = ""; // Limpiar mensaje de carga

          if (data && Array.isArray(data)) {
            data.forEach((usuario) => {
              listaUsuariosDiv.appendChild(crearElementoUsuario(usuario));
            });
            if (data.length === 0) {
              listaUsuariosDiv.innerHTML =
                "<p>No hay usuarios para mostrar.</p>";
            }
          } else {
            // Manejar respuesta JSON inesperada
            listaUsuariosDiv.innerHTML =
              "<p class='alert alert-warning'>Error: El formato de los datos de usuarios es incorrecto.</p>";
            console.error("Datos recibidos no son un array:", data);
          }
        } catch (e) {
          console.error("Error al cargar los usuarios:", e);
          listaUsuariosDiv.innerHTML = `<p class="alert alert-danger">Error al cargar los usuarios: ${e.message}. Asegúrese de que el Servlet esté accesible en la ruta /Servlet.</p>`;
        }
      }

      // Función de creación (Vanilla JS)
      async function crearUsuario() {
        const form = document.getElementById("create-user-form");
        const errorMessageElement = document.getElementById(
          "create-error-message"
        );
        errorMessageElement.classList.add("d-none");

        // Obtener valores directamente del DOM (Vanilla JS)
        const nombre = document.getElementById("new-user-name").value;
        const email = document.getElementById("new-user-email").value;
        const password = document.getElementById("new-user-password").value;
        const rol = document.getElementById("new-user-role").value;

        const newUser = { nombre, email, password, rol };

        const payload = {
          metodo: "POST",
          endpoint: "usuario/nueva",
          body: JSON.stringify(newUser),
          token: token,
        };

        try {
          // Uso de Fetch API (Vanilla JS)
          const response = await fetch("/frontend-taskmanager/Servlet", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            // Si el backend devuelve un error HTTP (p.ej. 400), lo capturamos aquí
            const errorText = await response.text();
            console.error(`Error HTTP ${response.status}:`, errorText);
            throw new Error(
              `Error HTTP: ${response.status}. Verifique la consola.`
            );
          }

          const data = await response.json();

          // Asumiendo que el backend devuelve un objeto si la creación fue exitosa
          if (data && (data.id || data.success)) {
            // Utilizamos el modal de Bootstrap 5 o un mensaje simple
            // Usando 'alert' por simplicidad, pero se recomienda un modal personalizado.
            alert(`Usuario ${nombre} creado con éxito.`);
            form.reset(); // Limpiar el formulario (Vanilla JS)
            listarUsuarios(); // Recargar la lista
          } else {
            const message =
              data.message ||
              "Error al crear el usuario. Credenciales duplicadas o datos incorrectos.";
            errorMessageElement.textContent = message;
            errorMessageElement.classList.remove("d-none");
          }
        } catch (e) {
          console.error("Error al crear el usuario:", e);
          errorMessageElement.textContent = e.message.includes("HTTP")
            ? e.message
            : "Error de red o del servidor al crear el usuario.";
          errorMessageElement.classList.remove("d-none");
        }
      }

      // Iniciar la carga de usuarios al cargar la página
      window.onload = listarUsuarios;
    </script>
  </body>
</html>
